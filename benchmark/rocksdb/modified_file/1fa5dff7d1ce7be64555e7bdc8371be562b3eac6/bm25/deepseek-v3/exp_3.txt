这次修改主要将循环内多个独立的条件合并为一次统一判断（并通过引入next_writer变量简化指针移位逻辑），以提高代码的清晰度和维护性，同时确保批处理组合各项条件正确满足。